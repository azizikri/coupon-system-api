// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.29.0
// source: coupons.sql

package db

import (
	"context"
)

const createCoupon = `-- name: CreateCoupon :one
INSERT INTO coupons (name, amount, remaining_amount, created_at)
VALUES ($1, $2, $3, NOW())
RETURNING name, amount, remaining_amount, created_at
`

type CreateCouponParams struct {
	Name            string `json:"name"`
	Amount          int32  `json:"amount"`
	RemainingAmount int32  `json:"remaining_amount"`
}

func (q *Queries) CreateCoupon(ctx context.Context, arg CreateCouponParams) (Coupon, error) {
	row := q.db.QueryRow(ctx, createCoupon, arg.Name, arg.Amount, arg.RemainingAmount)
	var i Coupon
	err := row.Scan(
		&i.Name,
		&i.Amount,
		&i.RemainingAmount,
		&i.CreatedAt,
	)
	return i, err
}

const decrementRemaining = `-- name: DecrementRemaining :one
UPDATE coupons
SET remaining_amount = remaining_amount - 1
WHERE name = $1 AND remaining_amount > 0
RETURNING name, amount, remaining_amount, created_at
`

func (q *Queries) DecrementRemaining(ctx context.Context, name string) (Coupon, error) {
	row := q.db.QueryRow(ctx, decrementRemaining, name)
	var i Coupon
	err := row.Scan(
		&i.Name,
		&i.Amount,
		&i.RemainingAmount,
		&i.CreatedAt,
	)
	return i, err
}

const getCouponByName = `-- name: GetCouponByName :one
SELECT name, amount, remaining_amount, created_at FROM coupons
WHERE name = $1
`

func (q *Queries) GetCouponByName(ctx context.Context, name string) (Coupon, error) {
	row := q.db.QueryRow(ctx, getCouponByName, name)
	var i Coupon
	err := row.Scan(
		&i.Name,
		&i.Amount,
		&i.RemainingAmount,
		&i.CreatedAt,
	)
	return i, err
}

const insertClaim = `-- name: InsertClaim :execrows
INSERT INTO claims (user_id, coupon_name, created_at)
VALUES ($1, $2, NOW())
ON CONFLICT (user_id, coupon_name) DO NOTHING
`

type InsertClaimParams struct {
	UserID     string `json:"user_id"`
	CouponName string `json:"coupon_name"`
}

func (q *Queries) InsertClaim(ctx context.Context, arg InsertClaimParams) (int64, error) {
	result, err := q.db.Exec(ctx, insertClaim, arg.UserID, arg.CouponName)
	if err != nil {
		return 0, err
	}
	return result.RowsAffected(), nil
}

const listClaimsByCoupon = `-- name: ListClaimsByCoupon :many
SELECT user_id FROM claims
WHERE coupon_name = $1
ORDER BY created_at ASC
`

func (q *Queries) ListClaimsByCoupon(ctx context.Context, couponName string) ([]string, error) {
	rows, err := q.db.Query(ctx, listClaimsByCoupon, couponName)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []string
	for rows.Next() {
		var user_id string
		if err := rows.Scan(&user_id); err != nil {
			return nil, err
		}
		items = append(items, user_id)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}
